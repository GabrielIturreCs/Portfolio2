<!-- Chat Trigger Button -->
<button (click)="toggleChat()"
    class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-slate-900/80 backdrop-blur-md border border-cyan-500/30 shadow-lg shadow-cyan-500/20 flex items-center justify-center group hover:scale-110 hover:border-cyan-500 transition-all duration-300">
    <!-- Brain/Spark Icon -->
    <div class="relative w-8 h-8">
        <svg *ngIf="!isOpen()" class="w-full h-full text-cyan-400 group-hover:text-cyan-300 transition-colors"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3M3.343 15.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
            </path>
        </svg>
        <svg *ngIf="isOpen()" class="w-full h-full text-cyan-400 group-hover:text-cyan-300 transition-colors"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <!-- Pulse Effect -->
        <div *ngIf="!isOpen()" class="absolute inset-0 rounded-full bg-cyan-400/20 animate-ping"></div>
    </div>
</button>

<!-- Chat Window -->
<div *ngIf="isOpen()" @slideUp
    class="fixed bottom-24 right-6 z-50 w-[380px] h-[600px] max-h-[calc(100vh-120px)] flex flex-col rounded-2xl overflow-hidden border border-slate-700/50 shadow-2xl shadow-black/50 bg-slate-900/80 backdrop-blur-xl">

    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-slate-700/50 bg-slate-900/50">
        <div class="flex items-center gap-3">
            <div class="relative w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 p-[1px]">
                <div class="w-full h-full rounded-full bg-slate-900 flex items-center justify-center overflow-hidden">
                    <img src="assets/images/unnamed (3)-Photoroom.png" alt="AI Assistant"
                        class="w-full h-full object-cover">
                </div>
                <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-slate-900">
                </div>
            </div>
            <div>
                <h3 class="font-bold text-white text-sm">Asistente Virtual</h3>
                <p class="text-xs text-cyan-400 font-medium">Online | IA de Gabriel</p>
            </div>
        </div>
        <button (click)="toggleChat()" class="text-slate-400 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Messages Body -->
    <div #scrollContainer class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth custom-scrollbar">

        <div *ngFor="let msg of messages()" @messageAnimation class="flex gap-3"
            [ngClass]="{'flex-row-reverse': msg.isUser}">

            <!-- Avatar -->
            <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xs overflow-hidden"
                [ngClass]="msg.isUser ? 'bg-cyan-600 text-white' : 'bg-slate-800 border border-slate-700'">
                <span *ngIf="msg.isUser">Tú</span>
                <img *ngIf="!msg.isUser" src="assets/images/unnamed (3)-Photoroom.png" alt="AI"
                    class="w-full h-full object-cover">
            </div>

            <!-- Bubble -->
            <div class="max-w-[80%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm" [ngClass]="msg.isUser 
                    ? 'bg-gradient-to-br from-cyan-600 to-blue-600 text-white rounded-tr-none' 
                    : 'bg-slate-800/80 border border-slate-700/50 text-slate-200 rounded-tl-none'">
                <p [innerHTML]="msg.text"></p>
                <span class="text-[10px] opacity-50 block mt-1 text-right">
                    {{ msg.timestamp | date:'HH:mm' }}
                </span>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div *ngIf="isTyping()" @messageAnimation class="flex gap-3">
            <div
                class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex-shrink-0 flex items-center justify-center text-xs overflow-hidden">
                <img src="assets/images/unnamed (3)-Photoroom.png" alt="AI" class="w-full h-full object-cover">
            </div>
            <div
                class="bg-slate-800/80 border border-slate-700/50 p-4 rounded-2xl rounded-tl-none flex gap-1 items-center">
                <div class="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        </div>

        <!-- Suggested Questions -->
        <div *ngIf="!isTyping() && messages().length > 0 && !messages()[messages().length - 1].isUser"
            class="flex flex-wrap gap-2 mt-4 animate-fade-in">
            <button *ngFor="let q of suggestedQuestions" (click)="sendMessage(q)"
                class="text-xs px-3 py-2 rounded-full bg-slate-800/50 border border-cyan-500/20 text-cyan-300 hover:bg-cyan-500/10 hover:border-cyan-500/50 transition-all duration-300 text-left">
                {{ q }}
            </button>
        </div>
    </div>

    <!-- Input Footer -->
    <div class="p-4 border-t border-slate-700/50 bg-slate-900/50">
        <form (ngSubmit)="sendMessage()" class="relative flex items-center gap-2">
            <input type="text" [(ngModel)]="newMessage" name="message" placeholder="Escribe tu pregunta..."
                [disabled]="isTyping()"
                class="w-full bg-slate-800/50 border border-slate-700 rounded-xl py-3 pl-4 pr-12 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 transition-all disabled:opacity-50">

            <button type="submit" [disabled]="!newMessage().trim() || isTyping()"
                class="absolute right-2 p-2 rounded-lg text-cyan-400 hover:bg-cyan-500/10 disabled:opacity-50 disabled:hover:bg-transparent transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </form>
        <div class="text-center mt-2">
            <p class="text-[10px] text-slate-500">Powered by Gemini AI ✨</p>
        </div>
    </div>
</div>